# 02_流量审计与网络拦截子系统

## 1. 流量接管方案 (Network Extension)

在 macOS 上使用 `Network Extension` 框架的 `PacketTunnelProvider` 实现系统级流量接管。

### 1.1 TUN 虚拟网卡
*   配置 `NEPacketTunnelNetworkSettings`。
*   **路由表接管**: 设置 `ipv4Settings.includedRoutes` 为 `0.0.0.0/0` (Default Route)，实现"抢占系统代理"。
*   **DNS 劫持**: 配置 `dnsSettings` 指向本地伪造 DNS Server (e.g., `198.18.0.1`)，捕获所有域名解析请求，防止 DNS 泄漏并用于流量后续映射。

### 1.2 用户态协议栈 (Rust Implementation)
*   **选型**: 采用 Rust 语言实现的 `smoltcp` 库。
    *   `smoltcp` 是一个独立的、事件驱动的 TCP/IP 堆栈，专为裸机实时系统设计，非常适合嵌入到 Network Extension 中，且内存安全。
*   **流程**: 
    1.  Swift 层收到 IP Packets (NEPacketTunnelFlow)。
    2.  通过 FFI 传递给 Rust 处理。
    3.  `smoltcp` 解析 IP 包，维护 TCP/UDP 状态机。
    4.  对于 TCP 连接，将 Payload 传递给上层 Proxy Handler。

## 2. SSL/TLS 中间人攻击 (MITM) 审计

核心需求是解密 HTTPS 流量以分析 URL 和内容。

### 2.1 证书伪造 (Rustls + Rcgen)
*   **根证书**: 在 Keychain 安装自签名 CA。
*   **动态签发**: 
    *   使用 `rcgen` 库在内存中实时生成叶子证书。
    *   根据连接握手时的 SNI 信息动态构建证书主题。
*   **TLS 握手**: 
    *   使用 `rustls` 库作为 TLS Server 端与 App 建立加密连接。
    *   使用 `rustls` (或系统 native-tls) 作为 TLS Client 端与目标服务器建立连接。

### 2.2 流量分析与规则引擎
*   **HTTP 解析**: 使用 `httparse` 库高效解析 HTTP Header 和 Body。
*   **白名单机制**:
    *   为了性能和隐私，部分域名（如银行、政府、Apple服务）通过 Pass-through 模式直连，不进行解密。
    *   通过 SNI 判断是否在白名单内。
*   **上报策略**:
    *   **规则匹配**: 检查 URL 是否匹配管理端下发的敏感规则 (存储在 `SQLite` 或内存 BloomFilter)。
    *   **响应长度过滤**: 仅当 Response Body 长度超过阈值或 Content-Type 符合特定类型时上报。
    *   **忽略静态资源**: 默认过滤 `.js`, `.css`, `.png` 等资源请求，减少上报量。

## 3. 网络环境检测

### 3.1 代理检测
*   检测是否存在其他代理软件（如 Clash, V2Ray）运行。
*   检查环境变量 `http_proxy`, `all_proxy`。
*   监控系统网络设置变化，防止代理权限被覆盖。

### 3.2 共享网络检测
*   **共享热点**: 比如通过检测 TTL 值的异常分布（连接设备的 TTL 减 1）。
*   **USB 网卡/Hub**: 通过 `IOKit` 监听网络设备挂载事件，识别非内置网卡的使用，防止绕过审计。
