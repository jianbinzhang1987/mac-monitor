# 03_终端监控与安全对抗子系统

## 1. 智能截屏策略
    
### 1.1 技术实现 (Hybrid)
*   **采集层 (Swift)**: 使用 macOS 12.3+ 的 `ScreenCaptureKit` 框架，高性能捕获屏幕或窗口内容。
*   **处理层 (Rust)**:
    1.  Swift 将 `CMSampleBuffer` 转换为原始像素数据，通过 FFI 传递给 Rust。
    2.  Rust 使用 `image` 库进行后续处理：
        *   格式转换 (BGRA -> JPEG/WebP)。
        *   图像缩放 (Resizing) 以减少体积。
*   **隐私保护与 OCR (Rust/Swift)**:
    *   **本地 OCR**: 调用 macOS 原生 `Vision` 框架 (Swift) 进行文字识别，结果传回 Rust 匹配规则。
    *   **敏感信息脱敏**: 
        *   在 Rust 层根据 OCR 坐标结果，使用 `image` 库对敏感区域进行高斯模糊。

### 1.2 应用级定向截图
*   **实现**: SCKit 支持 `SCContentFilter`，可指定 `SCWindow` 或 `SCRunningApplication`。
*   **逻辑**: Rust 维护截图策略配置 (SQLite)，Swift 根据配置构建 Filter。
*   **优先级**: 若配置了“应用截屏”，仅截取目标应用（如微信、Telegram）的窗口范围。
*   **频率控制**:
    *   社交类 (IM): 1次 / 1分钟。
    *   非社交类 (Browser): 1次 / 5分钟。
*   **遮挡处理**: 若目标窗口被遮挡，使用 `SCKit` 的窗口级捕获能力，确保获取无遮挡的内容。

## 2. 剪切板审计

*   **监听机制**: 轮询 `NSPasteboard.generalPasteboard.changeCount`。
*   **过滤策略**:
    *   检查当前激活窗口是否为浏览器 (Google Chrome, Safari, Firefox)。
    *   **只审计浏览器内的复制/粘贴操作**，忽略本地文档编辑。
*   **内容获取**: 读取 `stringForType:NSPasteboardTypeString`，记录内容及源进程信息。

## 3. 安全对抗与完整性保护
    
### 3.1 进程与文件保护 (Endpoint Security)
*   **技术栈**: 使用 macOS `EndpointSecurity` (ES) 框架。
*   **自身保护**:
    *   **Anti-Kill**: 监听 `ES_EVENT_TYPE_AUTH_SIGNAL`，若目标进程为 Agent 自身且信号为 KILL/TERM，直接返回 `ES_AUTH_RESULT_DENY`。
    *   **Anti-Tamper**: 监听 `ES_EVENT_TYPE_AUTH_UNLINK` (删除) / `ES_EVENT_TYPE_AUTH_ReNAME`，保护应用安装目录和 LaunchDaemons plist 文件。

### 3.2 异常行为检测
*   **逻辑流程**: 
    1.  Swift 捕获 ES 事件 (`ES_EVENT_TYPE_NOTIFY_EXEC`, `ES_EVENT_TYPE_NOTIFY_FORK`)。
    2.  将进程路径、签名信息传递给 Rust。
    3.  Rust 查阅 `SQLite` 黑名单库 (如 `clash-verge`, `proxifier`)。
    4.  若匹配，记录审计日志或触发告警。
*   **火狐浏览器处理**:
    *   由于 Firefox 默认可能使用独立证书存储或网络设置。
    *   检测到 Firefox 运行时，检查其代理设置。若未走系统代理，通过 AppleScript 或 Kill 信号强制关闭，或注入配置。

### 3.3 外设监控 (USB)
*   **监听 IOKit 事件**: 关注 `kIOUSBDeviceClassName`。
*   **识别设备类型**: 过滤 USB Mass Storage (存储) 和 Network Adapter (网卡)。
*   **上报**: 记录设备插入拔出时间、VendorID/ProductID。
