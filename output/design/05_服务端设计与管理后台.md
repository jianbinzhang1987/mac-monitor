# 05_服务端设计与管理后台

## 1. 系统架构

服务端基于 **RuoYi-Vue** 脚手架开发，采用经典的 Spring Boot + Vue 前后端分离架构。

### 1.1 技术栈 (Server Side)
*   **核心框架**: Spring Boot 2.x
*   **权限安全**: Spring Security + JWT
*   **持久层**: MyBatis (配合 PageHelper)
*   **数据库**: MySQL 5.7/8.0
*   **缓存**: Redis
*   **前端**: Vue 2.6 + Element UI 2.x

### 1.2 模块划分
在 RuoYi-Vue 现有模块基础上，新增或扩展以下业务模块：

*   `ruoyi-admin`: 统一 Web 入口，包含 Client API Controller。
*   `ruoyi-system`: 扩展业务逻辑，包含设备管理、策略管理、审计日志服务。
*   `ruoyi-framework`: 配置针对客户端 API 的安全过滤器 (Token 校验)。

## 2. 数据库设计

各类业务表通常添加 `create_by`, `create_time`, `update_by`, `update_time`, `remark` 等标准字段。

### 2.1 设备管理
**表名**: `monitor_device`
*   `device_id` (PK): 逻辑 ID。
*   `serial_number`: 硬件序列号 (唯一索引)。
*   `device_name`: 设备名称/主机名。
*   `os_version`: 操作系统版本 (e.g., macOS 14.2)。
*   `app_version`: 客户端版本号。
*   `status`: 在线状态 (0=离线, 1=在线)。
*   `last_heartbeat`: 最后心跳时间。
*   `policy_version`: 当前生效的策略版本号。
*   `registered_ip`: 注册时的 IP 地址。

### 2.2 策略管理
**表名**: `monitor_policy`
*   `policy_id` (PK): 策略 ID。
*   `policy_name`: 策略名称 (e.g., "研发部默认策略")。
*   `traffic_rules`: 流量审计规则 (JSON 格式，包含域名白名单、敏感URL关键词)。
*   `screenshot_rules`: 截屏策略 (JSON 格式，包含频率、OCR敏感词、应用黑名单)。
*   `agent_settings`: 客户端系统设置 (JSON，包含心跳间隔、是否允许USB等)。
*   `is_default`: 是否默认策略 (0=否, 1=是)。

### 2.3 审计日志
**表名**: `monitor_log_traffic` (仅存储敏感或采样流量)
*   `log_id` (PK)
*   `device_serial`: 设备序列号。
*   `audit_time`: 发生时间。
*   `url`: 请求 URL。
*   `method`: HTTP 方法。
*   `domain`: 域名。
*   `process_name`: 发起请求的进程名。
*   `risk_level`: 风险等级 (0=info, 1=warning, 2=danger)。

**表名**: `monitor_log_screenshot`
*   `log_id` (PK)
*   `device_serial`: 设备序列号。
*   `capture_time`: 截图时间。
*   `app_name`: 前台应用名称。
*   `window_title`: 窗口标题。
*   `ocr_text`: OCR 识别出的文本内容 (用于全文检索)。
*   `image_path`: 图片存储路径 (相对路径或 OSS URL)。
*   `tags`: 标签 (e.g., "包含敏感词: 薪资")。
*   `is_alert`: 是否触发告警。

**表名**: `monitor_log_behavior`
*   `log_id` (PK)
*   `device_serial`
*   `event_type`: 事件类型 (PROCESS_LANUCH, USB_INSERT, FILE_CHANGE)。
*   `detail`: 详细描述 (JSON)。

### 2.4 节点管理
**表名**: `monitor_pop_node`
*   `pop_id` (PK): 节点 ID。
*   `name`: 节点名称 (e.g., "HK-01")。
*   `host`: IP 或 域名。
*   `port`: 端口号。
*   `status`: 启用状态 (0=禁用, 1=启用)。
*   `latency_hint`: 推荐延迟参考值。

### 2.5 版本与维护
**表名**: `monitor_version`
*   `version_id` (PK)
*   `version_code`: 版本号 (e.g., "0.1.2")。
*   `download_url`: 安装包下载路径。
*   `is_force`: 是否强制更新 (0=否, 1=是)。
*   `changelog`: 更新日志。

### 2.6 指令队列
**表名**: `monitor_command_queue`
*   `command_id` (PK)
*   `device_serial`: 目标设备序列号。
*   `op_type`: 指令类型 (SCREENSHOT, RESTART, UPDATE_POLICY 等)。
*   `params`: 指令参数 (JSON 字符串)。
*   `exec_status`: 执行状态 (0=待领用, 1=已发送, 2=执行成功, 3=执行失败)。

## 3. 功能模块设计 (管理后台)

### 3.1 终端管理 (Vue 视图)
*   **设备列表**: 展示所有注册设备，状态高亮 (在线/离线)。支持按部门、IP 搜索。
*   **设备详情**: 查看设备硬件信息、当前策略、历史心跳曲线。
*   **远程指令**: 下发 "立即截屏", "重启客户端" 等指令。
    *   **实现机制**: 管理员操作后，系统向 `monitor_command_queue` 插入一条记录。客户端下次心跳时，服务端查询并返回该指令。

### 3.2 策略中心
*   **策略配置**: 提供可视化表单配置各种 JSON 规则。
    *   域名白名单: 支持批量导入/导出。
    *   OCR 敏感词: 标签式管理。
*   **策略下发**: 将策略绑定到特定设备或部门。配置变更后，更新 `policy_version`，客户端下次心跳时自动拉取。

### 3.3 审计日志
*   **综合查询**: 聚合展示三类日志。
*   **截图墙**: 网格流式布局展示截图，支持点击预览大图。
    *   **图片处理**: 服务端需提供缩略图接口。
    *   **隐私遮挡**: 若 OCR 识别结果包含敏感词坐标，管理端展示时也可选择二次遮挡。
*   **告警中心**: 针对高风险行为 (如访问赌博网站、插入未经授权 USB) 生成待办告警事件。
94: 
95: ### 3.4 节点管理模块 (Vue 视图)
96: *   **节点列表**: 提供 POP 节点的增删改查。
97: *   **分发配置**: 支持按设备组或标签开启/关闭特定的加速节点。
98: 
99: ### 3.5 升级管理中心
100: *   **发布版本**: 上传安装包并填写更新说明，设置灰度或全量更新策略。
101: *   **进度监控**: 实时统计各版本的在线分布情况及升级成功率。

## 4. 客户端 API 实现 (`ApiMonitorController`)

对应 Client 端的通信协议，服务端需在 `ruoyi-admin` 模块下实现以下 REST 接口。

### 4.1 认证与鉴权
*   **机制**: 区别于 Browser 端的 Session/Cookie，客户端 API 使用 Header `Authorization: Bearer <Token>`。
*   **实现**: 自定义一个 Spring Security Filter 或 Interceptor，验证 Token 有效性。
*   **Token 生成**: 首次注册/登录成功后签发 JWT。

### 4.2 核心接口
*   `POST /api/v1/login`:
    *   校验硬件指纹。
    *   若设备不存在，自动注册 (根据配置决定是否需人工审核)。
    *   返回 Token 和基础配置。
*   `POST /api/v1/heartbeat`:
    *   更新 `monitor_device` 表的 `last_heartbeat` 和 `status`。
    *   比较客户端上传的 `config_version` 与数据库中的 `policy_version`。
    *   **响应增强**:
        *   `server_time`: 返回 Unix 时间戳，用于客户端逻辑时钟同步。
        *   `commands`: 返回待处理的远程指令数组 (e.g., `["SCREENSHOT", "RESTART"]`)。
        *   `need_update`: 标记策略是否需要重新拉取。
*   `GET /api/v1/config`:
    *   获取当前设备适用的最新全量策略 JSON。
*   `GET /api/v1/pop/list`:
    *   返回当前租户/设备可用的 POP 节点列表，包含：`pop_id`, `name`, `host`, `port`, `latency_hint`。
*   `GET /api/v1/maintenance/update`:
    *   返回客户端更新信息：`latest_version`, `download_url`, `is_force_update`, `changelog`。
*   `GET /api/v1/maintenance/cert`:
    *   返回最新的国密 (SM) 证书下载地址及指纹信息。
*   `POST /api/v1/log/upload`:
    *   接收 Multipart/form-data (用于上传图片) 或 JSON Body (日志数据)。
    *   异步写入数据库 (推荐使用消息队列削峰，如 RuoYi 集成的 RabbitMQ/Redis Stream，若无，则使用 `@Async` 线程池)。
