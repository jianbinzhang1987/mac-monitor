# 01_架构设计与通信协议

## 1. 系统总体架构

项目采用 **Swift + Rust 混合架构**，利用 Swift 处理 macOS 系统级 API (ScreenCaptureKit, EndpointSecurity, NetworkExtension)，利用 Rust 处理核心业务逻辑、网络协议栈和跨平台算法，兼顾开发效率与运行性能。

### 1.1 核心组件

### 1.1 核心组件

*   **GUI App (Tauri v2)**:
    *   **前端**: Vue 3 + TypeScript + Ant Design Vue。
    *   **后端**: Tauri (Rust)，负责窗口管理、系统托盘及与 Audit Service 的 IPC 通信。
*   **Network Extension (Packet Tunnel Provider)**:
    *   **Shell (Swift)**: 负责与 macOS 系统交互，处理 VPN 生命周期，调用 Rust 静态库。
    *   **Core (Rust)**: `network-procotol-stack` 库。
        *   **协议栈**: 使用 `smoltcp` 实现用户态 TCP/IP 堆栈。
        *   **MITM**: 使用 `rustls` + `rcgen` 进行 TLS 解密和动态证书签发。
        *   **解析**: 使用 `httparse` 解析 HTTP 流量。
*   **Audit Service (XPC Service / Daemon)**:
    *   **Shell (Swift)**: 拥有高权限 (System Extension / Root)，调用 `EndpointSecurity` (ES) 和 `ScreenCaptureKit` (SCKit)。
    *   **Core (Rust)**: `audit-logic-core` 库。
        *   **存储**: 使用 `sqlx` + `SQLite` 本地存储策略和暂存日志。
        *   **加密**: 使用 `libsm` 实现国密算法 (SM2/SM3/SM4) 保护敏感数据。
        *   **上报**: 使用 `reqwest` 异步上报日志。
        *   **图像**: 使用 `image` 库处理截屏数据 (缩放/裁剪/格式转换)。
*   **Server (RuoYi-Vue)**:
    *   **后端**: Spring Boot 2.x 管理设备状态、下发策略及接收日志。
    *   **数据库**: MySQL + Redis。
    *   **管理端 GUI**: Vue 2 + Element UI。

### 1.2 进程间通信 (IPC)

*   **GUI <-> Audit Service**:
    *   利用 Rust 的 `interprocess` 库实现跨平台的 Named Pipe 或 Unix Domain Socket 通信。
    *   GUI 下发配置，Audit Service 上报状态。
*   **Network Extension <-> Audit Service**:
    *   **App Groups**: 共享文件容器，用于传递大块数据或配置 (SQLite DB 文件共享)。
    *   **IPC**: 通过 `interprocess` 建立连接，由 Network Extension 将拦截到的 HTTP 元数据流式通过 socket 发送给 Audit Service 统一入库和上报。

## 2. 通信协议设计 (Client - Server)

客户端与服务端通过 HTTPS/WebSocket 进行安全通信。

### 2.1 基础协议
*   **传输层**: TLS v1.3
*   **数据格式**: Protobuf (高性能) 或 JSON (易调试)，建议核心日志上报使用 Protobuf。
*   **认证**: JWT (JSON Web Token) + 设备硬件指纹 (Serial Number / UUID)。

### 2.2 核心接口定义

#### 2.2.1 鉴权与登录
*   `POST /api/v1/login`
    *   Request: 用户名, 密码, 硬件指纹, 客户端版本。
    *   Response: Token, 初始配置 (POP点列表, 证书更新策略)。

#### 2.2.2 心跳保活与逻辑时钟
*   `POST /api/v1/heartbeat`
    *   频率: 每 30s - 60s (可配置)。
    *   Request: Token, 当前逻辑时钟 (Lamport Clock), POP 点状态, 简略性能指标。
    *   Response: 服务端逻辑时钟, 是否有新配置 (ConfigVersion), 时间校准值。
    *   **逻辑时钟机制**: 客户端维护本地逻辑时钟，每次心跳从服务端获取基准时间，结合本地单调时钟计算，确保日志时间戳主要依赖与服务端的相对偏移，防止用户篡改本地时间。

#### 2.2.3 策略下发
*   `GET /api/v1/config`
    *   内容: 审计规则（URL黑白名单）、截屏策略（频率、敏感词）、软件更新信息。

#### 2.2.4 日志上报
*   `POST /api/v1/log/traffic` (流量日志)
*   `POST /api/v1/log/audit` (行为/截图日志)
    *   支持批量上报 + 失败重试机制。

## 3. 软件生命周期管理

### 3.1 自动升级
*   启动时检查 `current_version` vs `remote_version`。
*   若有更新，后台下载安装包（`.pkg` 或 `.dmg`）。
*   校验签名与完整性。
*   提示用户或强制静默更新（需高权限 Helper 支持）。

### 3.2 证书管理
*   客户端内置根证书（用于 HTTPS 解密）。
*   支持通过 `GET /api/v1/cert/update` 动态更新根证书（应对证书过期或泄露风险）。
*   更新流程：下载新证书 -> 吊销旧证书信任 -> 安装并信任新证书 (需调用 `security` 命令, 涉及通过 Helper 提权)。

## 4. 安全性设计
*   **本地端口保护**:
    *   Audit Service 监听的 IPC 端口（如 HTTP server 用于调试或本地通信）必须绑定到 `127.0.0.1`。
    *   启用防火墙规则，拒绝非本机 IP 访问相关端口。
