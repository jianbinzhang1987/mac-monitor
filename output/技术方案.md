# 互联网终端上网审计系统 - macOS 客户端技术方案

## 1. 总体架构设计

本方案不依赖传统 `Clash` 架构，而是基于 macOS 现代化的 **System Extension** 体系进行全新设计。采用 **Tauri (GUI) + NetworkExtension (网络核) + XPC Service (审计核)** 的分离式架构，确保高稳定性、高性能与系统级安全对抗能力。

### 1.1 核心技术栈

- **GUI 壳 (用户交互)**: Tauri v2 (Rust + Vue 3)
- **网络核心 (流量接管)**: NetworkExtension Framework (Swift 壳 + Rust协议栈)
- **审计与监控 (系统行为)**: XPC Service + Endpoint Security Framework (Swift/Rust)
- **数据存储**: SQLite (加密存储)

### 1.2 架构图示

```mermaid
graph TD
    subgraph "Main App (GUI Layer)"
        UI[Tauri Frontend (Vue 3)]
        RustMain[Rust Sidecar logic]
        UI -- Commands --> RustMain
    end

    subgraph "Network Extension (System Privileged)"
        NE_Swift[Packet Tunnel Provider (Swift)]
        NE_Rust[User Space Networking (Rust / smoltcp)]
        NE_MitM[SSL MitM Proxy (Rustls)]
        
        NE_Swift -- IP Packets (FFI) --> NE_Rust
        NE_Rust -- TCP Streams --> NE_MitM
    end

    subgraph "Audit Service (Background Daemon)"
        SCK[ScreenCaptureKit (截屏)]
        Vision[Vision Framework (OCR & 脱敏)]
        ESF[Endpoint Security (文件/进程保护)]
        IOKit[IOKit (外设拔插检测)]
        
        SCK --> Vision
    end

    RustMain -- XPC --> NE_Swift
    RustMain -- XPC --> Audit Service
    
    NE_MitM -- Log Data --> Audit Service
    Audit Service -- Encrypted Data --> Server[审计服务端]
```

---

## 2. 核心模块详细设计

### 2.1 网络流量审计 (Network Audit)

这是系统的核心，需实现全局流量接管与 HTTPS 深度审计。

- **流量接管 (TUN Mode)**
  - **技术**: **NetworkExtension Framework (PacketTunnelProvider)**
  - **优势**: macOS 官方推荐方案，稳定性极高，作为 VPN 运行，能有效防止被系统杀后台，且能接管所有 App 流量。
  - **实现**: Swift 负责与系统 NE 接口交互，获取 TUN 文件句柄；Rust (`smoltcp` 或 `lwip`) 负责在用户态处理 IP 数据包，重组 TCP/UDP 流。

- **SSL/TLS 深度审计 (MitM)**
  - **技术**: **Rustls + rcgen** (Rust)
  - **原理**: 
    1. 协议栈拦截 443 端口流量。
    2. 使用内置 Root CA 动态签发目标域名的伪造证书。
    3. 建立中间人连接：Client <-> Proxy <-> Server。
    4. **内存审计**: 在内存中解密 HTTP Payload，提取 URL、Method、Headers、Body。
    5. **规则过滤**: 根据下发的审计规则（域名白名单、敏感词），决定是否记录或阻断。
  - **注意**: 需实现证书安装逻辑，引导用户/MDM 信任根证书。

### 2.2 屏幕监控与隐私保护 (Screen Monitoring)

- **高性能截屏**
  - **技术**: **ScreenCaptureKit (SCK)**
  - **实现**: 使用 macOS 12.3+ 原生 API，独立线程进行流式高频截屏。
  - **智能策略**: 仅在画面变化幅度超过阈值、或处于特定应用（社交软件）活动时触发。

- **OCR 与隐私脱敏**
  - **技术**: **Apple Vision Framework + CoreImage**
  - **流程**:
    1. 获取截图 `CMSampleBuffer`。
    2. Vision 识别文本区域（如密码框、身份证号、银行卡号）。
    3. **内存脱敏**: 立即对敏感区域应用高斯模糊 (Gaussian Blur) 或遮罩。
    4. 仅保存/上报处理后的图片，**绝不落盘原图**。

### 2.3 系统安全与异常对抗 (Security & Antagonism)

- **进程与文件保护**
  - **技术**: **Endpoint Security Framework (ESF)**
  - **实现**: 订阅 `ES_EVENT_TYPE_AUTH_OPEN`, `ES_EVENT_TYPE_AUTH_UNLINK` 等事件。当发现非授权进程试图修改/删除审计客户端文件时，直接在内核层拒绝操作。

- **外设与网络环境检测**
  - **技术**: **IOKit**
  - **功能**:
    - 监听 `kIOGeneralInterest`，识别 USB WLAN 网卡、4G/5G 模组的插入。
    - 监听 `SCDynamicStore`，检测网络环境变化（如 IP 变动、Gateway 变动）。

- **剪切板审计**
  - **技术**: `NSPasteboard`
  - **策略**: 监听 `changeCount`，通过 `NSWorkspace` 判断当前活跃窗口是否为浏览器。仅在浏览器前台时读取剪切板文本。

---

## 3. 关键技术难点与应对

| 难点 | 解决方案 | 备注 |
| :--- | :--- | :--- |
| **HTTPS 解密性能** | 使用 **Rust** 处理加解密，避免 Go/JS 的 GC 开销；利用 Rust 的零拷贝特性。 | 性能提升关键 |
| **无感截屏** | 使用 **ScreenCaptureKit** 替代旧的 CGWindowList，CPU 占用率可降低 80% 以上。 | 避免电脑卡顿 |
| **防卸载/防杀** | 利用 **Endpoint Security** 进行内核级自我保护；NetworkExtension 自带守护属性。 | 提高生存能力 |
| **Rust/Swift 互调** | 使用 **Swift Bridge** 或构建 C-ABI 动态库，明确边界，减少跨语言调用频率。 | 架构融合难点 |

## 4. 总结

该方案彻底摒弃了基于开源代理核心（Clash）“魔改”的路径，转而使用 macOS 原生系统能力构建。虽然开发门槛和成本较高（涉及内核扩展、驱动级开发），但能提供**最佳的稳定性、最低的资源占用（符合CPU<5%要求）和最强的安全对抗能力**，完全满足企业级终端审计系统的严苛需求。
