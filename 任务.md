# 项目开发任务进度

## 📅 当前状态 (2026-01-15)

### ✅ 已完成事项
- **OCR 识别优化**
  - 在 `ScreenCapturer.swift` 中为 `VNRecognizeTextRequest` 增加了 `zh-Hans` 和 `zh-Hant` 支持。
  - 开启了 `automaticallyDetectsLanguage` 以提升中英文混排识别准确率。
  - 验证：数据库中的 `ocr_text` 已能正确记录中文内容。

- **Rust 客户端模型对齐**
  - 更新 `models/mod.rs` 以匹配 RuoYi 后端的字段命名（如 `risk_level`, `capture_time` 等）。
  - 更新 `db/mod.rs` 数据库表结构，移除过期字段并添加审计所需字段。

- **上传模块增强**
  - 在 `uploader/mod.rs` 中实现了基于 `reqwest` 的 `multipart/form-data` 文件上传功能。
  - 实现了自动登录逻辑 (`/api/v1/login`)，支持通过 `app_code` 和 `app_secret` 自动换取 JWT Token。
  - 在 `sync.rs` 中实现了“先传图、后报日志”的双阶段上传流程。

- **后端接口扩展**
  - 在 `ApiMonitorController.java` 中新增了 `@Anonymous` 权限的 `/upload/screenshot` 接口，用于接收客户端上传的截图文件。

---

## 🚀 待处理事项 (挂起中)

### 1. 后端集成调试
- [ ] **[高优先级] 修复上传接口 401 认证失败**
  - 现象：客户端日志显示 `Upload file failed: 请求访问：/api/v1/upload/screenshot，认证失败`。
  - 原因：RuoYi 后端 `SecurityConfig` 可能拦截了 `/api/v1/upload/screenshot`。
  - 方案：检查 `mac-monitor-server` 中的安全配置，放行该匿名接口。

### 2. 客户端问题排查
- [ ] **本地截图未保存**
  - 现象：尽管日志显示尝试上传，但本地 `screenshots` 文件夹为空。
  - 排查：检查 Rust 核心的 `analyze_enhanced_image` 保存逻辑及 `uploader` 的文件清理策略。

### 3. 功能增强
- [ ] **服务重启与生效**：需要重新编译并重启 RuoYi 后端服务，以使新添加的 `ApiMonitorController` 接口生效。
- [ ] **权限验证修复**：解决客户端调用 `/upload/screenshot` 时返回的 “认证失败” (401) 问题。需检查 `SecurityConfig.java` 是否正确放行了该匿名接口。
- [ ] **全链路验证**：
  - 验证图片是否成功保存到服务器存储目录 (`/profile/upload/...`)。
  - 验证数据库中 `monitor_log_screenshot` 表的 `url` 字段是否能正确访问。

### 2. 功能增强
- [ ] **设备信息动态获取**：目前 `uploader/mod.rs` 中的序列号和设备名仍为硬编码，需对接系统 API 获取真实值。
- [ ] **心跳逻辑完善**：根据服务端返回的 `needUpdate` 标志位，触发配置同步 (`/config`)。

---

## 📝 备注
用户指示暂时停止集成开发，转为文档记录进度。后续恢复时，建议从 **后端服务重启** 开始排查。
