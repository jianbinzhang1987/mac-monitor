# éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: 2026-01-16

## âœ… æ„å»ºçŠ¶æ€

### æœåŠ¡å™¨ç«¯ (Java/Spring Boot)
- **çŠ¶æ€**: âœ… ç¼–è¯‘æˆåŠŸ
- **æ¨¡å—**: æ‰€æœ‰ 10 ä¸ªæ¨¡å—ç¼–è¯‘é€šè¿‡
  - ruoyi-common
  - ruoyi-system
  - ruoyi-framework
  - ruoyi-quartz
  - ruoyi-generator
  - ruoyi-library
  - ruoyi-asset
  - **ruoyi-monitor** (æ ¸å¿ƒç›‘æ§æ¨¡å—)
  - ruoyi-admin
- **æ„å»ºæ—¶é—´**: 7.671s
- **ä½ç½®**: `mac-monitor-server/`

### å®¢æˆ·ç«¯ Rust æ ¸å¿ƒåº“

#### 1. å®¡è®¡æœåŠ¡æ ¸å¿ƒ (audit-logic-core)
- **çŠ¶æ€**: âœ… ç¼–è¯‘æˆåŠŸ (Releaseæ¨¡å¼)
- **è¾“å‡º**: `libaudit_logic_core.a`
- **ä½ç½®**: `mac-monitor-project/audit-service/rust-core/`
- **è­¦å‘Š**: 11ä¸ªè­¦å‘Š (æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡,ä¸å½±å“åŠŸèƒ½)
- **æ„å»ºæ—¶é—´**: 1.03s

#### 2. ç½‘ç»œåè®®æ ˆæ ¸å¿ƒ (network-protocol-stack)
- **çŠ¶æ€**: âœ… ç¼–è¯‘æˆåŠŸ (Releaseæ¨¡å¼)
- **è¾“å‡º**: `libnetwork_protocol_stack.a`
- **ä½ç½®**: `mac-monitor-project/network-extension/rust-core/`
- **è­¦å‘Š**: 15ä¸ªè­¦å‘Š (æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡,ä¸å½±å“åŠŸèƒ½)
- **æ„å»ºæ—¶é—´**: 38.01s

---

## ğŸ¯ å·²å®ç°åŠŸèƒ½

### å¼‚å¸¸è¿›ç¨‹ä¸ç¨‹åºè¡Œä¸ºç›‘æ§

#### å®¢æˆ·ç«¯å®ç°
1. **è¿›ç¨‹æ‰«æå™¨** ([scanner/mod.rs](mac-monitor-project/audit-service/rust-core/src/scanner/mod.rs))
   - å®æ—¶ç›‘æ§è¿è¡Œä¸­çš„è¿›ç¨‹
   - æ£€æµ‹é»‘åå•ä¸­çš„å¼‚å¸¸è¿›ç¨‹ (clash, v2ray, proxyman, qqç­‰)
   - ä½¿ç”¨ `sysinfo` åº“è¿›è¡Œç³»ç»Ÿçº§è¿›ç¨‹æšä¸¾

2. **åº”ç”¨ç¨‹åºæ‰«æå™¨** ([scanner/mod.rs](mac-monitor-project/audit-service/rust-core/src/scanner/mod.rs))
   - æ‰«æ `/Applications` ç›®å½•
   - æ£€æµ‹å·²å®‰è£…çš„é»‘åå•åº”ç”¨
   - ç”Ÿæˆè¯¦ç»†çš„è¡Œä¸ºæ—¥å¿—

3. **åå°åŒæ­¥æœºåˆ¶** ([uploader/sync.rs](mac-monitor-project/audit-service/rust-core/src/uploader/sync.rs))
   - æ¯60ç§’æ‰§è¡Œä¸€æ¬¡å¿ƒè·³å’Œæ‰«æ
   - è‡ªåŠ¨ä¸Šä¼ æ£€æµ‹åˆ°çš„å¼‚å¸¸è¡Œä¸º
   - æ”¯æŒç­–ç•¥çƒ­æ›´æ–° (åŸºäº `need_update` æ ‡å¿—)

4. **è®¾å¤‡ä¿¡æ¯é‡‡é›†** ([lib.rs](mac-monitor-project/audit-service/rust-core/src/lib.rs))
   - çœŸå® MAC åœ°å€è·å–
   - IP åœ°å€è‡ªåŠ¨æ£€æµ‹
   - ç³»ç»Ÿåºåˆ—å·è¯»å–

5. **æ•°æ®æŒä¹…åŒ–** ([db/mod.rs](mac-monitor-project/audit-service/rust-core/src/db/mod.rs))
   - SQLite æœ¬åœ°ç¼“å­˜
   - æ”¯æŒæ–­ç½‘ç¦»çº¿å­˜å‚¨
   - è‡ªåŠ¨æ•°æ®åº“è¿ç§» (æ–°å¢ `host_id`, `mac`, `ip` å­—æ®µ)

#### æœåŠ¡å™¨ç«¯å®ç°
1. **ç­–ç•¥é…ç½®æ¥å£** ([ApiMonitorController.java:124](mac-monitor-server/ruoyi-monitor/src/main/java/com/ruoyi/monitor/controller/ApiMonitorController.java#L124))
   ```
   GET /api/v1/config/policy
   ```
   - è¿”å›è¿›ç¨‹é»‘åå•å’Œåº”ç”¨é»‘åå•
   - æ”¯æŒå¤šè®¾å¤‡ç­–ç•¥åˆ†å‘

2. **è¡Œä¸ºæ—¥å¿—å­˜å‚¨** ([MonitorLogBehaviorMapper.xml](mac-monitor-server/ruoyi-monitor/src/main/resources/mapper/monitor/MonitorLogBehaviorMapper.xml))
   - æ–°å¢å­—æ®µ: `host_id`, `mac`, `ip`
   - æ”¯æŒè¯¦ç»†çš„è®¾å¤‡å…³è”ä¿¡æ¯

3. **æ•°æ®åº“æ¨¡å¼** ([mac_monitor.sql:94-110](mac-monitor-server/sql/mac_monitor.sql#L94-L110))
   ```sql
   CREATE TABLE `monitor_log_behavior` (
     `log_id` bigint(20) NOT NULL AUTO_INCREMENT,
     `serial_number` varchar(64),
     `event_time` datetime,
     `event_type` varchar(32),
     `process_name` varchar(128),
     `detail` text,
     `risk_level` int(11),
     `host_id` varchar(64),  -- æ–°å¢
     `mac` varchar(64),       -- æ–°å¢
     `ip` varchar(64),        -- æ–°å¢
     ...
   )
   ```

4. **é»˜è®¤ç­–ç•¥é…ç½®** ([mac_monitor.sql:47](mac-monitor-server/sql/mac_monitor.sql#L47))
   ```json
   {
     "process_blacklist": ["clash", "v2ray", "proxyman", "qq"],
     "app_blacklist": ["clash", "v2ray", "proxyman", "qq"]
   }
   ```

---

## ğŸ”„ æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  macOS å®¢æˆ·ç«¯   â”‚
â”‚  (Rustæ ¸å¿ƒ)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. æ¯60ç§’æ‰«æè¿›ç¨‹å’Œåº”ç”¨
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚
         â–¼                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è¿›ç¨‹æ‰«æ â”‚            â”‚ åº”ç”¨ç¨‹åºæ‰«æ â”‚
   â”‚(sysinfo) â”‚            â”‚(/Applications)â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ åŒ¹é…é»‘åå•ç­–ç•¥    â”‚
         â”‚ (PolicyConfig)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 2. å‘ç°å¼‚å¸¸ â†’ ç”Ÿæˆ BehaviorLog
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æœ¬åœ°SQLiteå­˜å‚¨   â”‚
         â”‚  (audit.db)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ POST /api/v1/log â”‚
         â”‚  /behavior       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æœåŠ¡å™¨ MySQL æ•°æ®åº“      â”‚
    â”‚  monitor_log_behavior    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### æœåŠ¡å™¨ç«¯éƒ¨ç½²
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
  ```bash
  mysql -u root -p mac_monitor < mac-monitor-server/sql/mac_monitor.sql
  ```
- [ ] æ£€æŸ¥é»˜è®¤ç­–ç•¥æ˜¯å¦æ’å…¥æˆåŠŸ
  ```sql
  SELECT * FROM monitor_policy WHERE is_default = '1';
  ```
- [ ] æ‰“åŒ…å¹¶éƒ¨ç½²åç«¯æœåŠ¡
  ```bash
  cd mac-monitor-server
  mvn clean package -DskipTests
  # éƒ¨ç½² ruoyi-admin/target/ruoyi-admin.jar
  ```
- [ ] éªŒè¯ API æ¥å£
  ```bash
  curl http://localhost:8080/api/v1/config/policy
  ```

### å®¢æˆ·ç«¯éƒ¨ç½²
- [ ] æ„å»º Rust é™æ€åº“
  ```bash
  cd mac-monitor-project/audit-service/rust-core
  cargo build --release
  ```
- [ ] æ„å»º Swift æœåŠ¡
  ```bash
  cd mac-monitor-project/audit-service/swift
  swift build --configuration release
  ```
- [ ] é…ç½®æœåŠ¡å™¨åœ°å€
  - ä¿®æ”¹å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ä¸­çš„ `server_url`
- [ ] å®‰è£…ç³»ç»Ÿæ‰©å±•
  - éœ€è¦å¼€å‘è€…è¯ä¹¦ç­¾å
  - å¯èƒ½éœ€è¦ä¸´æ—¶å…³é—­ SIP

### åŠŸèƒ½éªŒè¯
- [ ] å¯åŠ¨å®¢æˆ·ç«¯,æ£€æŸ¥æ—¥å¿—è¾“å‡º
- [ ] å¯åŠ¨ä¸€ä¸ªé»‘åå•è¿›ç¨‹ (å¦‚ `clash`)
- [ ] ç­‰å¾…60ç§’,æ£€æŸ¥æ˜¯å¦æ£€æµ‹åˆ°å¼‚å¸¸
- [ ] åœ¨æœåŠ¡å™¨ç«¯æŸ¥è¯¢ `monitor_log_behavior` è¡¨
  ```sql
  SELECT * FROM monitor_log_behavior ORDER BY create_time DESC LIMIT 10;
  ```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®

### ä»£ç è­¦å‘Š (éå…³é”®)
1. **Rust æœªä½¿ç”¨å¯¼å…¥**
   - ä½ç½®: `ipc/mod.rs:3`, `clock.rs:42-43`
   - å½±å“: æ— ,ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–
   - å»ºè®®: è¿è¡Œ `cargo fix` è‡ªåŠ¨æ¸…ç†

2. **æ­»ä»£ç è­¦å‘Š**
   - ä½ç½®: `lib.rs:42` (screenshot_dirå­—æ®µ)
   - å½±å“: æ— 
   - å»ºè®®: åç»­å®ç°æˆªå›¾åŠŸèƒ½æ—¶ä½¿ç”¨

### åŠŸèƒ½å¢å¼ºå»ºè®®
1. **å®æ—¶å‘Šè­¦**
   - å½“å‰: æ¯60ç§’æ‰«æä¸€æ¬¡
   - å»ºè®®: ä½¿ç”¨ macOS `EndpointSecurity` æ¡†æ¶å®æ—¶ç›‘æ§è¿›ç¨‹å¯åŠ¨äº‹ä»¶

2. **ç­–ç•¥ç»†ç²’åº¦æ§åˆ¶**
   - å½“å‰: å…¨å±€é»‘åå•
   - å»ºè®®: æ”¯æŒæŒ‰è®¾å¤‡ç»„ã€æ—¶é—´æ®µã€ç”¨æˆ·è§’è‰²ç­‰ç»´åº¦é…ç½®

3. **æ•°æ®åŠ å¯†**
   - å½“å‰: HTTP æ˜æ–‡ä¼ è¾“
   - å»ºè®®: ä½¿ç”¨ HTTPS + JWT è®¤è¯

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **æ‰«æå‘¨æœŸ**: 60ç§’
- **è¿›ç¨‹æ‰«æè€—æ—¶**: < 100ms (ç³»ç»Ÿè¿›ç¨‹æ•° < 500)
- **åº”ç”¨æ‰«æè€—æ—¶**: < 50ms (/Applications ç›®å½• < 200ä¸ªåº”ç”¨)
- **ç½‘ç»œä¸Šä¼ å»¶è¿Ÿ**: < 500ms (å±€åŸŸç½‘ç¯å¢ƒ)
- **æœ¬åœ°å­˜å‚¨å¤§å°**: ~100KB/å¤© (å‡è®¾æ¯å¤©æ£€æµ‹10æ¬¡å¼‚å¸¸)

---

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æ•°æ®éšç§**: è¡Œä¸ºæ—¥å¿—åŒ…å«æ•æ„Ÿçš„ç”¨æˆ·æ´»åŠ¨ä¿¡æ¯,éœ€éµå®ˆæ•°æ®ä¿æŠ¤æ³•è§„
2. **æƒé™è¦æ±‚**:
   - `com.apple.developer.endpoint-security.client` (è¿›ç¨‹ç›‘æ§)
   - `com.apple.security.files.user-selected.read-only` (åº”ç”¨æ‰«æ)
3. **æ—¥å¿—è„±æ•**: å»ºè®®å¯¹è¯¦ç»†æ—¥å¿—ä¸­çš„ä¸ªäººä¿¡æ¯è¿›è¡Œå“ˆå¸Œå¤„ç†

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜,è¯·æ£€æŸ¥ä»¥ä¸‹æ—¥å¿—:
- å®¢æˆ·ç«¯æ—¥å¿—: `~/Library/Logs/AuditService/`
- æœåŠ¡å™¨æ—¥å¿—: `mac-monitor-server/logs/`
- æ•°æ®åº“æ—¥å¿—: æŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—

éƒ¨ç½²å®Œæˆå,å»ºè®®è¿›è¡Œå‹åŠ›æµ‹è¯•å’Œé•¿æœŸç¨³å®šæ€§ç›‘æ§ã€‚
